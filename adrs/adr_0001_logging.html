<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ADR 0001 - Logging - Merino Book</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../intro.html">Intro</a></li><li class="chapter-item expanded affix "><li class="part-title">General Documentation</li><li class="chapter-item expanded "><a href="../api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item expanded "><a href="../firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item expanded "><a href="../ops.html"><strong aria-hidden="true">3.</strong> Configuring Merino (Operations)</a></li><li class="chapter-item expanded "><a href="../data.html"><strong aria-hidden="true">4.</strong> Data collection</a></li><li class="chapter-item expanded "><a href="../dev/index.html"><strong aria-hidden="true">5.</strong> Working on the code</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev/showroom.html"><strong aria-hidden="true">5.1.</strong> Merino Showroom</a></li><li class="chapter-item expanded "><a href="../dev/logging-and-metrics.html"><strong aria-hidden="true">5.2.</strong> Logging and Metrics</a></li><li class="chapter-item expanded "><a href="../dev/testing.html"><strong aria-hidden="true">5.3.</strong> Testing Strategies</a></li><li class="chapter-item expanded "><a href="../dev/dependencies.html"><strong aria-hidden="true">5.4.</strong> Development Dependencies</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Architecture Decision Records</li><li class="chapter-item expanded affix "><a href="../adrs/adr_0001_logging.html" class="active">ADR 0001 - Logging</a></li><li class="chapter-item expanded affix "><a href="../adrs/adr_0002_hashing.html">ADR 0002 - Hashing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="choosing-a-logging-library-for-merino"><a class="header" href="#choosing-a-logging-library-for-merino">Choosing a logging library for Merino</a></h1>
<ul>
<li>Status: accepted</li>
<li>Date: 2021-05-11</li>
</ul>
<p>Tracking issue:
<a href="https://github.com/mozilla-services/merino/issues/15">mozilla-services/merino#15</a></p>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>Merino needs a system to produce logging. Rust has several options to do this,
with no clear winner. What library should Merino use?</p>
<h3 id="the-log-crate"><a class="header" href="#the-log-crate">The <code>log</code> Crate</a></h3>
<p>There is a de facto standard logging library for Rust,
<a href="https://crates.io/crates/log"><code>log</code></a>. It is an important part of the decision,
but it is not a solution to the problem: it is a logging <em>facade</em> that provides
a way for libraries to produce their own logs, but does not provide any logging
capabilities itself. Without a logger crate to use it with, the logs compile
away to nothing.</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<ul>
<li>Sentry integration should be available</li>
<li>MozLog format should be supported</li>
<li>There should be both human and machine friendly logging output options.</li>
<li>Library compatibility</li>
</ul>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ol>
<li><a href="https://crates.io/crates/slog">slog</a></li>
<li><a href="https://crates.io/crates/tracing">tracing</a></li>
</ol>
<ul>
<li>Something from the <code>log</code> ecosystem</li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p>Option 2 - Tracing. Although Slog has more momentum at this time, Tracing sets
us up for a better set of tools long term.</p>
<h2 id="pros-and-cons-of-the-options"><a class="header" href="#pros-and-cons-of-the-options">Pros and Cons of the Options <!-- optional --></a></h2>
<h3 id="option-1---slog"><a class="header" href="#option-1---slog">Option 1 - Slog</a></h3>
<blockquote>
<p><code>slog</code> is an ecosystem of reusable components for structured, extensible,
composable and contextual logging for Rust.</p>
</blockquote>
<p>Slog's first release was 0.1.0 in June of 2016, and it's 1.0 release was in
September of 2016.</p>
<p>To use it, developers create logger objects that provide methods to produce log
lines and create sub-loggers. These loggers must be passed to lower level code
explicitly to be used.</p>
<p>Slog is compatible with the de facto <code>log</code> crate. Log lines emitted using that
system (such as by libraries) can be routed to a logger object, with no loss of
detail. Few libraries use slog directly, and none of the libraries that are
currently used in Merino do at all. Since libraries aren't using <code>slog</code>, it will
be harder to make them participate in the logging hierarchy.</p>
<p>Structured logging is supported. Logs can carry associated data, which can aid
in the machine readability of logs.</p>
<p>The tree of loggers is built explicitly through the loggers objects, and
subloggers must be aware of superloggers, since the only way to get a sublogger
is to call a method on a logger. This separates the logging structure from the
call stack, but makes it awkward to recover that information should it be
helpful. This means that logging generally has to be passed as arguments to many
functions, making the tree of loggers less flexible.</p>
<p>The Sentry library for Rust has support for slog. There is a a
<a href="https://crates.io/crates/slog-mozlog-json">MozLog crate</a> for slog that Mozilla
wrote.</p>
<ul>
<li>Good, because structured logging helps provide more useful logs.</li>
<li>Good, because it has Sentry integration.</li>
<li>Good, because it already has MozLog integration.</li>
<li>Bad, because it has little library support.</li>
<li>Bad, because explicitly building the logging tree is rigid.</li>
</ul>
<h3 id="option-2---tracing"><a class="header" href="#option-2---tracing">Option 2 - Tracing</a></h3>
<blockquote>
<p><code>tracing</code> is a framework for instrumenting Rust programs to collect
structured, event-based diagnostic information.</p>
</blockquote>
<p>Tracing's first release was 0.0.0 in November of 2017. It has not had a 1.0
release. It's latest release is 0.1.26, published April 2021.</p>
<p>To use it, developers set up a global or scope-based subscriber of logs, which
collects <em>spans</em> and <em>events</em> that are generated in the code. Spans can be
<code>enter</code>ed and <code>exit</code>ed. During the time between these, all spans and events are
associated with the entered span as their parent. This association happens
explicitly, and can cross call boundaries. However, spans can be entered and
exited in more fine grained ways if needed.</p>
<p>Tracing is compatible with the de facto <code>log</code> crate. Log lines emitted using
that system are seen as events in Tracing, with no loss of detail.</p>
<p>Structured logging is supported. Both spans and events can carry associated
data. This data can be accessed hierarchically, building up a context of
execution.</p>
<p>The tree of spans is built by entering spans. Loggers do not have to be aware of
their parents, their logs are placed in the context of whatever set of spans has
been entered at that moment. because [ one like we did with slog.</p>
<p>Tracing is developed as a part of the Tokio ecosystem, the same that our web
framework (Actix), http client (Reqwest), and async runtime (Tokio) are
developed under. It has some library support. Additionally, since the tree of
spans is built more implicitly, libraries that use the <code>log</code> facade can
participate in our structured logging.</p>
<ul>
<li>Good, because structured logging helps provide more useful logs.</li>
<li>Good, because it has good integration into the libraries we use.</li>
<li>Good, because implicitly building the logging hierarchy and context is
flexible.</li>
<li>Bad, because it lacks Sentry support.</li>
<li>Bad, because it lacks MozLog support.</li>
</ul>
<h3 id="option-3---something-in-the-log-ecosystem"><a class="header" href="#option-3---something-in-the-log-ecosystem">Option 3 - Something in the <code>log</code> ecosystem</a></h3>
<p>This option was not considered deeply because <code>log</code> does not support structured
logging. Not being able to attach concrete data to logs makes much of the
logging tasks much harder.</p>
<ul>
<li>Bad, because it lacks structured logging.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../dev/dependencies.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../adrs/adr_0002_hashing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../dev/dependencies.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../adrs/adr_0002_hashing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
