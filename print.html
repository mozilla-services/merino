<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Merino Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Intro</a></li><li class="chapter-item expanded affix "><li class="part-title">General Documentation</li><li class="chapter-item expanded "><a href="api.html"><strong aria-hidden="true">1.</strong> Using the HTTP API</a></li><li class="chapter-item expanded "><a href="firefox.html"><strong aria-hidden="true">2.</strong> Configuring Firefox and Merino Environments</a></li><li class="chapter-item expanded "><a href="ops.html"><strong aria-hidden="true">3.</strong> Configuring Merino (Operations)</a></li><li class="chapter-item expanded "><a href="data.html"><strong aria-hidden="true">4.</strong> Data collection</a></li><li class="chapter-item expanded "><a href="dev/index.html"><strong aria-hidden="true">5.</strong> Working on the code</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="dev/dependencies.html"><strong aria-hidden="true">5.1.</strong> Development Dependencies</a></li><li class="chapter-item expanded "><a href="dev/logging-and-metrics.html"><strong aria-hidden="true">5.2.</strong> Logging and Metrics</a></li><li class="chapter-item expanded "><a href="dev/testing.html"><strong aria-hidden="true">5.3.</strong> Testing Strategies</a></li><li class="chapter-item expanded "><a href="dev/admin.html"><strong aria-hidden="true">5.4.</strong> Merino Admin</a></li><li class="chapter-item expanded "><a href="dev/showroom.html"><strong aria-hidden="true">5.5.</strong> Merino Showroom</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Architecture Decision Records</li><li class="chapter-item expanded affix "><a href="adrs/adr_0001_logging.html">ADR 0001 - Logging</a></li><li class="chapter-item expanded affix "><a href="adrs/adr_0002_hashing.html">ADR 0002 - Hashing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Merino Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="merino"><a class="header" href="#merino">Merino</a></h1>
<p>A service to provide address bar suggestions to Firefox. Some of this content
comes from third parties. In this case, Merino serves as a privacy preserving
buffer.</p>
<h2 id="about-the-name"><a class="header" href="#about-the-name">About the Name</a></h2>
<p>This project drives an important part of Firefox's &quot;felt experience&quot;. That is,
the feeling of using Firefox, hopefully in a delightful way. The word &quot;felt&quot; in
this phrase refers to feeling, but it can be punned to refer to the
<a href="https://en.wikipedia.org/wiki/Felt">textile</a>. Felt is often made of wool, and
Merino wool (from Merino sheep) produces exceptionally smooth felt.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="merino-api-documentation"><a class="header" href="#merino-api-documentation">Merino API documentation</a></h1>
<p>This page describes the API endpoints available on Merino.</p>
<h2 id="suggest"><a class="header" href="#suggest">Suggest</a></h2>
<p>Endpoint: <code>/api/v1/suggest</code></p>
<p>Example: <code>/api/v1/suggest?q=nelson%20mand&amp;client_variants=one,two</code></p>
<p>The primary endpoint for the browser to consume, this endpoint consumes user
input and suggests pages the user may want to visit. The expectation is that
this is shown alongside other content the browser suggests to the user, such as
bookmarks and history.</p>
<p>This endpoint accepts GET requests and takes parameters as query string values
and headers.</p>
<h3 id="query-parameters"><a class="header" href="#query-parameters">Query Parameters</a></h3>
<ul>
<li>
<p><code>q</code> - The query that the user has typed. This is expected to be a partial
input, sent as fast as once per keystroke, though a slower period may be
appropriate for the user agent.</p>
</li>
<li>
<p><code>client_variants</code> - Optional. A comma-separated list of any experiments or
rollouts that are affecting the client's Suggest experience. If Merino
recognizes any of them it will modify its behavior accordingly.</p>
</li>
<li>
<p><code>providers</code> - Optional. A comma-separated list of providers to use for this
request. See the <code>/providers</code> endpoint below for valid options. If provided,
only suggestions from the listed providers will be returned. If not provided,
Merino will use a built-in default set of providers. The default set of
providers can be seen in the <code>/providers</code> endpoint.</p>
</li>
</ul>
<h3 id="headers"><a class="header" href="#headers">Headers</a></h3>
<ul>
<li>
<p><code>Accept-Language</code> - The locale preferences expressed in this header in
accordance with <a href="https://datatracker.ietf.org/doc/html/rfc2616/#section-14.4">RFC 2616 section 14.4</a> will be used to
determine suggestions. Merino maintains a list of supported locales. Merino
will choose the locale from it's list that has the highest <code>q</code> (quality) value
in the user's <code>Accept-Language</code> header. Locales with <code>q=0</code> will not be used.</p>
<p>If no locales match, Merino will not return any suggestions. If the header is
not included or empty, Merino will default to the <code>en-US</code> locale.</p>
<p>If the highest quality, compatible language produces no suggestion results,
Merino will return an empty list instead of attempting to query other
languages.</p>
</li>
<li>
<p><code>User-Agent</code> - A user's device form factor, operating system, and
browser/Firefox version are detected from the <code>User-Agent</code> header included in
the request.</p>
</li>
</ul>
<h3 id="other-derived-inputs"><a class="header" href="#other-derived-inputs">Other derived inputs</a></h3>
<ul>
<li>
<p>Location - The IP address of the user or nearest proxy will be used to
determine location. This location may be as granular as city level, depending
on server configuration.</p>
<p>Users that use VPN services will be identified according to the VPN exit node
they use, allowing them to change Merino's understanding of their location.
VPN exit nodes are often mis-identified in geolocation databases, and may
produce unreliable results.</p>
</li>
</ul>
<h3 id="response"><a class="header" href="#response">Response</a></h3>
<h4 id="response-object"><a class="header" href="#response-object">Response object</a></h4>
<p>The response will be a JSON object containing the following keys:</p>
<ul>
<li><code>client_variants</code> - A list of strings specified from the <code>client_variants</code>
parameter in the request.</li>
<li><code>server_variants</code> - A list of strings indicating the server variants.</li>
<li><code>request_id</code> - A string identifier identifying every API request sent from Firefox.</li>
<li><code>suggestions</code> - A list of suggestion objects described as below.</li>
</ul>
<h4 id="suggestion-object"><a class="header" href="#suggestion-object">Suggestion object</a></h4>
<ul>
<li>
<p><code>block_id</code> - a number that can be used, along with the <code>provider</code> field below,
to uniquely identify this suggestion. Two suggestions with the same <code>provider</code>
and <code>block_id</code> should be treated as the same suggestion, even if other fields,
such as <code>click_url</code> change. Merino will enforce that they are equivalent from
a user's point of view.</p>
</li>
<li>
<p><code>full_keyword</code> - In the case that the query was a partial match to the
suggestion, this is the completed query that would also match this query. For
example, if the user was searching for fruit and typed &quot;appl&quot;, this field
might contain the string &quot;apples&quot;. This is suitable to show as a completion of
the user's input. This field should be treated as plain text.</p>
</li>
<li>
<p><code>title</code> - The full title of the suggestion resulting from the query. Using the
example of apples above, this might be &quot;Types of Apples in the Pacific
Northwest&quot;. This field should be treated as plain text.</p>
</li>
<li>
<p><code>url</code> - The URL of the page that should be navigated to if the user selects
this suggestion. This will be a resource with the title specified in the
<code>title</code> field.</p>
</li>
<li>
<p><code>impression_url</code> - A provider specified telemetry URL that should be notified
if the browser shows this suggestion to the user. This is used along with
<code>click_url</code> to monitor the relevancy of suggestions. For more details see
<a href="api.html#interaction-pings">Interaction Pings</a>, below. This field may be null, in
which case no impression ping is required for this suggestion provider.</p>
</li>
<li>
<p><code>click_url</code> - A provider specified telemetry URL that should be notified if
the user selects this suggestion. This should only be notified as the result
of positive user action, and only if the user has navigated to the page
specified in the <code>url</code> field. For more details see
<a href="api.html#interaction-pings">Interaction Pings</a>, below. This field may be null, in
which case no click ping is required for this suggestion provider.</p>
</li>
<li>
<p><code>provider</code> - A string that identifies the provider of this suggestion, such as
&quot;adM&quot;. In general, this field is not intended to be directly displayed to the user.</p>
</li>
<li>
<p><code>advertiser</code> - The name of the advertiser, such as &quot;Nike&quot;. Note that a <code>provider</code>
could have multiple <code>advertiser</code>s.</p>
</li>
<li>
<p><code>is_sponsored</code> - A boolean indicating if this suggestion is sponsored content.
If this is true, the UI must indicate to the user that the suggestion is
sponsored.</p>
</li>
<li>
<p><code>icon</code> - A URL of an image to display alongside the suggestion. This will be a
small square image, suitable to be included inline with the text, such as a
site's favicon.</p>
</li>
<li>
<p><code>score</code> - A value between 0.0 and 1.0 used to compare suggestions. When
choosing a suggestion to show the user, higher scored suggestions are
preferred.</p>
</li>
</ul>
<h3 id="response-headers"><a class="header" href="#response-headers">Response Headers</a></h3>
<p>Responses will carry standard HTTP caching headers that indicate the validity of
the suggestions. User agents should prefer to provide the user with cached
results as indicated by these headers.</p>
<h3 id="response-status-codes"><a class="header" href="#response-status-codes">Response Status Codes</a></h3>
<ul>
<li>200 OK - Suggestions provided normally.</li>
<li>4xx - Client error. See response for details.</li>
<li>5xx - Internal server error. Try again later.</li>
</ul>
<p><a id="interaction-pings"></a></p>
<h2 id="interaction-pings"><a class="header" href="#interaction-pings">Interaction Pings</a></h2>
<p>When a Firefox user views or selects a suggestion from Merino, Firefox will send
an impression or a click ping to a Mozilla-controlled service indicating this
user interaction. Some suggestion providers may also need that interaction data
for reporting and relevancy optimization. Firefox will not send the pings to
those providers directly, rather, it will delegate those to a Mozilla-controlled
service, by which the interaction pings will be sent to the <code>impression_url</code> or
<code>click_url</code> specified by the providers.</p>
<p>If the URL for an interaction ping is not specified (for example, <code>click_url</code> is
<code>null</code>), then no ping should be sent to the provider for that action. However,
this interaction ping is always sent to the Mozilla-controlled service unless
the user opts out the telemetry collection of Firefox.</p>
<p>The required behavior for interaction pings is TBD.</p>
<h2 id="providers"><a class="header" href="#providers">Providers</a></h2>
<p>Endpoint: <code>/api/v1/providers</code></p>
<p>This endpoint gives a list of available providers, along with their
<em>availability</em>. It accepts GET requests and takes no parameters.</p>
<h3 id="response-1"><a class="header" href="#response-1">Response</a></h3>
<p>The response will be a JSON object containing the key <code>providers</code>, which is a
map where the keys to this map are the IDs of the provider, and the values are
provider metadata object. Each provider metadata object will have the following
format:</p>
<ul>
<li>
<p><code>id</code> - A string that can be used to identify this provider. This ID can be
used for the <code>providers</code> field of the suggest API.</p>
</li>
<li>
<p><code>availability</code> - A string describing how this provider is used in Merino. It
will be one of:</p>
<ul>
<li><code>&quot;enabled_by_default&quot;</code> - This provider will be used for requests that don't
specify providers, and it should be provided to the user as a selection that
can be turned off.</li>
<li><code>&quot;disabled_by_default&quot;</code> - This provider is not used automatically. It should
be provided to the user as a selection that could be turned on.</li>
<li><code>&quot;hidden&quot;</code> - This provider is not used automatically. It should not be
provided to the user as an option to turn on. It may be used for debugging
or other internal uses. */</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-firefox-and-merino-environments"><a class="header" href="#configuring-firefox-and-merino-environments">Configuring Firefox and Merino Environments</a></h1>
<p>As of Firefox 93.0, Merino is not enabled by default. To enable it, set the
Firefox preference <code>browser.urlbar.merino.enabled</code> to <code>true</code>. By default Merino
will connect to the production environments. This is controlled with the
<code>browser.urlbar.merino.endpointURL</code> preference. See below for other options.</p>
<p>You can also query any of the endpoint URLs below with something like</p>
<pre><code class="language-sh">curl 'https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest?q=your query'
</code></pre>
<h2 id="environments"><a class="header" href="#environments">Environments</a></h2>
<h3 id="production"><a class="header" href="#production">Production</a></h3>
<p><em>Endpoint URL</em>: <a href="https://merino.services.mozilla.com/api/v1/suggest">https://merino.services.mozilla.com/api/v1/suggest</a></p>
<p>The primary environment for end users. Firefox is configured to use this by
default. As of 2021-10-25, this server is not active yet.</p>
<p>This environment only deploys manually as a result of operations triggering
deploys.</p>
<h3 id="stage"><a class="header" href="#stage">Stage</a></h3>
<p><em>Endpoint URL</em>: <a href="https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest">https://stage.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest</a></p>
<p>This environment is used for manual and load testing of the server. It is not
guaranteed to be stable or available. It is used as a part of the deploy process
to verify new releases before they got to production.</p>
<p>This environment automatically deploys new tags on the Merino repository.</p>
<h3 id="dev"><a class="header" href="#dev">Dev</a></h3>
<p><em>Endpoint URL</em>: <a href="https://dev.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest">https://dev.merino.nonprod.cloudops.mozgcp.net/api/v1/suggest</a></p>
<p>This environment is unstable and is not guaranteed to work. It's primary use is
as a development area for operations.</p>
<p>This environment automatically deploys the latest commit to the <code>main</code> branch of
the repository.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuring-merino-operations"><a class="header" href="#configuring-merino-operations">Configuring Merino (Operations)</a></h1>
<h2 id="settings"><a class="header" href="#settings">Settings</a></h2>
<p>Merino's settings can be specified in two ways: a YAML file placed in a specific
location, or via environment variables. Not all settings can be set with
environment variables, however. Notably, provider configuration must be done
with its own YAML file.</p>
<h3 id="file-organization"><a class="header" href="#file-organization"><a href="ops.html#file-organization">File organization</a></a></h3>
<p>These are the settings sources, with later sources overriding earlier ones.</p>
<ul>
<li>
<p>A base configuration checked into the repository, in <code>config/base.yaml</code>. This
provides the default values for most settings.</p>
</li>
<li>
<p>Per-environment configuration files in the <code>config</code> directory. The environment
is selected using the environment variable <code>MERINO__ENV</code>. The settings for
that environment are then loaded from <code>config/${env}.yaml</code>, if it exists. The
default environment is &quot;development&quot;. A &quot;production&quot; environment is also
provided.</p>
</li>
<li>
<p>A local configuration file not checked into the repository, at
<code>config/local.yaml</code>. This file is in <code>.gitignore</code> and is safe to use for local
configuration and secrets if desired.</p>
</li>
<li>
<p>Environment variables that begin with <code>MERINO</code> and use <code>__</code> (a double
underscore) as a level separator. For example, <code>Settings::http::workers</code> can
be controlled from the environment variable <code>MERINO__HTTP__WORKERS</code>.</p>
</li>
</ul>
<p>The names given below are of the form &quot;<code>yaml.path</code> (<code>ENVIRONMENT_VAR</code>)&quot;</p>
<h3 id="general"><a class="header" href="#general">General</a></h3>
<ul>
<li>
<p><code>env</code> (<code>MERINO__ENV</code>) - Only settable from environment variables. Controls
which environment configuration is loaded, as described above.</p>
</li>
<li>
<p><code>debug</code> (<code>MERINO__DEBUG</code>) - Boolean that enables additional features to debug
the application. This should not be set to true in public environments, as it
reveals all configuration, including any configured secrets.</p>
</li>
<li>
<p><code>public_documentation</code> (<code>MERINO__PUBLIC_DOCUMENTATION</code>) - When users visit the
root of the server, they will be redirected to this URL. Preferable a public
wiki page that explains what the server is and does.</p>
</li>
<li>
<p><code>log_full_request</code> (<code>MERINO__LOG_FULL_REQUEST</code>) - Boolean that enables logging
the entire suggestion request object as a part of the tracing log, including
the search query. When the setting is false (default), the suggest request
object should be logged, but the search query should be blank. Note that
access to the collected query logs is restricted.</p>
</li>
</ul>
<h3 id="http"><a class="header" href="#http">HTTP</a></h3>
<p>Settings for the HTTP server.</p>
<ul>
<li><code>http.listen</code> (<code>MERINO__HTTP__LISTEN</code>) - An IP and port to listen on, such as
<code>127.0.0.1:8080</code> or <code>0.0.0.0:80</code>.</li>
<li><code>http.workers</code> (<code>MERINO__HTTP__WORKERS</code>) - Optional. The number of worker
threads that should be spawned to handle tasks. If not provided will default
to the number of logical CPU cores available.</li>
</ul>
<h3 id="logging"><a class="header" href="#logging">Logging</a></h3>
<p>Settings to control the format and amount of logs generated.</p>
<ul>
<li>
<p><code>logging.format</code> - The format to emit logs in. One of</p>
<ul>
<li><code>pretty</code> (default in development) - Multiple lines per event, human-oriented
formatting and color.</li>
<li><code>compact</code>- A single line per event, with formatting and colors.</li>
<li><code>mozlog</code> (default in production) - A single line per event, formatted as
JSON in <a href="https://wiki.mozilla.org/Firefox/Services/Logging">MozLog</a> format.</li>
</ul>
</li>
<li>
<p><code>logging.info</code> (<code>MERINO__LOGGING__LEVELS</code>) - Minimum level of logs that should
be reported. This should be a number of <em>entries</em> separated by commas (for
environment variables) or specified as list (YAML).</p>
<p>This will be combined with the contents of the <code>RUST_LOG</code> environment variable
for compatibility. <code>RUST_LOG</code> will take precedence over this setting. If the
environment variable <code>MERINO__LOGGING__LEVELS</code> is specified, all the settings
in the YAML file will be ignored.</p>
<p>Each entry can be one of <code>ERROR</code>, <code>WARN</code>, <code>INFO</code>, <code>DEBUG</code>, or <code>TRACE</code> (in
increasing verbosity), with an optional component that specifies the source of
the logs. For example <code>INFO,merino_web=DEBUG,reqwest=WARN</code> would set the
default log level to INFO, but would lower the level to <code>DEBUG</code> for the
<code>merino-web</code> crate and raise it to <code>WARN</code> for the reqwest crate.</p>
</li>
</ul>
<h3 id="metrics"><a class="header" href="#metrics">Metrics</a></h3>
<p>Settings for Statsd/Datadog style metrics reporting.</p>
<ul>
<li>
<p><code>metrics.sink_host</code> (<code>MERINO__METRICS__SINK_ADDRESS</code>) - The IP or hostname to
send metrics to over UDP. Defaults to <code>0.0.0.0</code>.</p>
</li>
<li>
<p><code>metrics.sink_port</code> (<code>MERINO__METRICS__SINK_PORT</code>) - The port to send metrics
to over UDP. Defaults to 8125.</p>
</li>
<li>
<p><code>max_queue_size_kb</code> (<code>MERINO__METRICS__MAX_QUEUE_SIZE_KB</code>) - The maximum size
of the buffer that holds events waiting to be sent. If unsent events rise
above this, then metrics will be lost. Defaults to 32KB.</p>
</li>
</ul>
<h3 id="sentry"><a class="header" href="#sentry">Sentry</a></h3>
<p>Error reporting via Sentry.</p>
<ul>
<li><code>sentry.mode</code> (<code>MERINO__SENTRY__MODE</code>) - The type of Sentry integration to
enable. One of <code>release</code>, <code>server_debug</code>, <code>local_debug</code>, or <code>disabled</code>. The
two <code>debug</code> settings should only be used for local development.</li>
</ul>
<p>If <code>sentry.mode</code> is set to <code>release</code>, then the following two settings are
required:</p>
<ul>
<li><code>sentry.dsn</code> - Configuration to connect to the Sentry project.</li>
<li><code>sentry.env</code> - The environment to report to Sentry. Probably &quot;production&quot;,
&quot;stage&quot;, or &quot;dev&quot;.</li>
</ul>
<p>If <code>sentry.mode</code> is set to <code>disabled</code>, no Sentry integration will be activated.
If it is set to <code>local_debug</code>, the DSN will be set to a testing value
recommended by Sentry, and extra output will be included in the logs.</p>
<p>The mode can be set to <code>server_debug</code>, which will allow testing real integration
with Sentry. Sentry integration and debug logging will be activated. It is
recommended to use the <a href="https://sentry.prod.mozaws.net/operations/merino-local">merino-local</a> sentry environment.
See that page for DSN information. The following two settings are required:</p>
<ul>
<li><code>sentry.dsn</code> - Configuration to connect to the Sentry project. A testing
project should be used.</li>
<li><code>sentry.who</code> - Your username, which will be used as the environment, so that
you can filter your results out in Sentry's web interface.</li>
</ul>
<h3 id="redis"><a class="header" href="#redis">Redis</a></h3>
<p>Connection to Redis. This is used by the Redis provider cache below.</p>
<ul>
<li><code>redis.url</code> (<code>MERINO__REDIS__URL</code>) - The URL to connect Redis at. Example:
<code>redis://127.0.0.1/0</code>.</li>
</ul>
<h3 id="remote_settings"><a class="header" href="#remote_settings">Remote_settings</a></h3>
<p>Connection to Remote Settings. This is used by the Remote Settings suggestion
provider below.</p>
<ul>
<li>
<p><code>remote_settings.server</code> (<code>MERINO__REMOTE_SETTINGS__SERVER</code>) - The server to
sync from. Example: <code>https://firefox.settings.services.mozilla.com</code>.</p>
</li>
<li>
<p><code>remote_settings.default_bucket</code> (<code>MERINO__REMOTE_SETTINGS__DEFAULT_BUCKET</code>) -
The bucket to use for Remote Settings providers if not specified in the
provider config. Example: &quot;main&quot;.</p>
</li>
<li>
<p><code>remote_settings.default_collection</code>
(<code>MERINO__REMOTE_SETTINGS__DEFAULT_COLLECTION</code>) - The collection to use for
Remote Settings providers if not specified in the provider config. Example:
&quot;quicksuggest&quot;.</p>
</li>
</ul>
<h3 id="location"><a class="header" href="#location">Location</a></h3>
<p>Configuration for determining the location of users.</p>
<ul>
<li><code>location.maxmind_database</code> (<code>MERINO__LOCATION__MAXMIND_DATABASE</code>) - Path to a
MaxMind GeoIP database file. Optional. If not specified, geolocation will be
disabled.</li>
</ul>
<h3 id="provider-configuration"><a class="header" href="#provider-configuration">Provider Configuration</a></h3>
<p>The configuration for suggestion providers.</p>
<p>Note that the provider settings are configured either by a separate YAML file
located in <code>config/providers</code> or by a remote source backed by an HTTP endpoint.
You can use <code>provider_settings</code> to configure how &amp; where Merino to load the
settings.</p>
<h4 id="provider-settings"><a class="header" href="#provider-settings"><code>Provider Settings</code></a></h4>
<p>You can specify the &quot;type&quot; and the &quot;location&quot; of the provider settings. The
&quot;type&quot; could be <code>local</code> or <code>remote</code>. For <code>local</code> sources, use <code>path</code> to specify
the location; Use <code>uri</code> for <code>remote</code> sources. Note that only JSON is supported
for remote sources, whereas all the common formats (JSON, YAML, TOML, etc) are
supported for local sources.</p>
<p><em>Examples</em>:</p>
<ul>
<li>A local source</li>
</ul>
<pre><code class="language-yaml">provider_settings:
  type: local
  path: ./config/providers/base.yaml
</code></pre>
<ul>
<li>A remote source</li>
</ul>
<pre><code class="language-yaml">provider_settings:
  type: remote
  uri: https://example.org/settings
</code></pre>
<h4 id="configuration-object"><a class="header" href="#configuration-object">Configuration Object</a></h4>
<p>Each provider configuration has a <code>type</code>, listed below, and it's own individual
settings.</p>
<p><em>Example</em>:</p>
<pre><code class="language-yaml">wiki_fruit:
  type: wiki_fruit
</code></pre>
<h4 id="configuration-file"><a class="header" href="#configuration-file">Configuration File</a></h4>
<p>Each configuration file should be a map where the keys are provider IDs will be
used in the API to enable and disable providers per request. The values are
provider configuration objects, detailed below. Some providers can takes other
providers as children. Because of this, each key in this config is referred to
as a &quot;provider tree&quot;.</p>
<p><em>Example</em>:</p>
<pre><code class="language-yaml">adm:
  type: memory_cache
  inner:
    type: remote_settings
    collection: &quot;quicksuggest&quot;
wiki_fruit:
  type: wiki_fruit
debug:
  type: debug
</code></pre>
<h4 id="leaf-providers"><a class="header" href="#leaf-providers">Leaf Providers</a></h4>
<p>These are production providers that generate suggestions.</p>
<ul>
<li>Remote Settings - Provides suggestions from a RS collection, such as the
suggestions provided by adM. See also the top level configuration for Remote
Settings, below.
<ul>
<li><code>type=remote_settings</code></li>
<li><code>bucket</code> - Optional. The name of the Remote Settings collection to pull
suggestions from. If not specified, the global default will be used.</li>
<li><code>collection</code> - Optional. The name of the Remote Settings collection to pull
suggestions from. If not specifeid, the global default will be used.</li>
<li><code>resync_interval_sec</code> - Optional. The time between re-syncs of Remote
Settings data, in seconds. Defaults to 3 hours.</li>
</ul>
</li>
</ul>
<h4 id="combinators"><a class="header" href="#combinators">Combinators</a></h4>
<p>These are providers that extend, combine, or otherwise modify other providers.</p>
<ul>
<li>
<p>Multiplexer - Combines providers from multiple sub-providers.</p>
<ul>
<li><code>type=multiplexer</code></li>
<li><code>providers</code> - A list of other provider configs to draw suggestions from.</li>
</ul>
<p><em>Example</em>:</p>
<pre><code class="language-yaml">sample_multi:
  type: multiplexer
  providers:
    - fixed:
      type: fixed
      value: I'm a banana
    - debug:
      type: debug
</code></pre>
</li>
<li>
<p>Timeout - Returns an empty response if the wrapped provider takes too long to
respond.</p>
<ul>
<li><code>type=timeout</code></li>
<li><code>inner</code> - Another provider configuration to generate suggestions with.</li>
<li><code>max_time_ms</code> - The time, in milliseconds, that a provider has to respond
before an empty result is returned.</li>
</ul>
</li>
<li>
<p>KeywordFilter - Filters the suggestions coming from the wrapped provider with
the given blocklist.</p>
<ul>
<li><code>type=keyword_filter</code></li>
<li><code>suggestion_blocklist</code> - The map used to define the blocklist rules. Each
entry contains a rule id and an associated regular expression that
recommended titles are matched against.</li>
<li><code>inner</code> - The wrapped provider to draw suggestions from.</li>
</ul>
<p><em>Example</em>:</p>
<pre><code class="language-yaml">filtered:
  type: keyword_filter
  suggestion_blocklist:
    no_banana: &quot;(Banana|banana|plant)&quot;
  inner:
    type: multiplexer
    providers:
      - fixed:
        type: fixed
        value: I'm a banana
      - debug:
        type: debug
</code></pre>
</li>
<li>
<p>Stealth - Runs another provider, but hides the results. Useful for load
testing of new behavior.</p>
<ul>
<li><code>type=stealth</code></li>
<li><code>inner</code> - Another provider configuration to run.</li>
</ul>
</li>
</ul>
<h4 id="caches"><a class="header" href="#caches">Caches</a></h4>
<p>These providers take suggestions from their children and cache them for future
use.</p>
<ul>
<li>
<p>Memory Cache - An in-memory, per process cache.</p>
<ul>
<li><code>type=memory_cache</code></li>
<li><code>default_ttl_sec</code> - The time to store suggestions before, if the inner
provider does not specify a time.</li>
<li><code>cleanup_interval_sec</code> - The cache will automatically remove expired entries
with this period. Note that expired entries are also removed dynamically if
a matching request is processed.</li>
<li><code>max_removed_entries</code> - While running the cleanup task, at most this many
entries will be removed before cancelling the task. This should be used to
limit the maximum amount of time the cleanup task takes. Defaults to
100_000.</li>
<li><code>default_lock_timeout_sec</code> - The amount of time a cache entry can be locked
for writing.</li>
<li><code>inner</code> - Another provider configuration to generate suggestions with.</li>
</ul>
</li>
<li>
<p>Redis Cache - A remote cache that can be shared between processes.</p>
<ul>
<li><code>type=redis_cache</code></li>
<li><code>default_ttl_sec</code> - The time to store suggestions before, if the inner
provider does not specify a time.</li>
<li><code>default_lock_timeout_sec</code> - The amount of time a cache entry can be locked
for writing.</li>
<li><code>inner</code> - Another provider configuration to generate suggestions with.</li>
</ul>
</li>
</ul>
<h4 id="development-providers"><a class="header" href="#development-providers">Development providers</a></h4>
<p>These should not be used in production, but are useful for development and
testing.</p>
<ul>
<li>
<p>Debug - Echos back the suggestion request that it receives formatted as JSON
in the <code>title</code> field of a suggestion.</p>
<ul>
<li><code>type=debug</code></li>
</ul>
</li>
<li>
<p>WikiFruit - A very basic provider that suggests Wikipedia articles for the
exact phrases &quot;apple&quot;, &quot;banana&quot;, and &quot;cherry&quot;.</p>
<ul>
<li><code>type=wiki_fruit</code></li>
</ul>
</li>
<li>
<p>Null - A provider that never suggests anything. Useful to fill in combinators
and caches for testing.</p>
<ul>
<li><code>type=&quot;null&quot;</code> - Note that <code>null</code> in YAML is an actual null value, so this
must be specified as the string <code>&quot;null&quot;</code>.</li>
</ul>
</li>
<li>
<p>Fixed - A suggestion provider that provides a fixed response with a
customizable title.</p>
<ul>
<li><code>value</code> - A string that will be used for the title of the fixed suggestion.
Required.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="data-collection"><a class="header" href="#data-collection">Data collection</a></h1>
<p>This page should list all metrics and logs that Merino is expected to emit in
production, including what should be done about them, if anything.</p>
<h2 id="logs"><a class="header" href="#logs">Logs</a></h2>
<p>This list does not include any <code>DEBUG</code> or <code>TRACE</code> level events, since those are
not logged by default in production. The events below are grouped by crate, and
the level and type of the log is listed.</p>
<h3 id="merino-adm"><a class="header" href="#merino-adm"><code>merino-adm</code></a></h3>
<ul>
<li>
<p><code>INFO adm.remote-settings.sync-start</code> - The Remote Settings provider has
started syncing records.</p>
</li>
<li>
<p><code>WARN adm.remote-settings.empty</code> - After syncing no records were found in the
Remote Settings collection.</p>
</li>
</ul>
<h3 id="merino-cache"><a class="header" href="#merino-cache"><code>merino-cache</code></a></h3>
<ul>
<li><code>INFO cache.redis.save-error</code> - There was an error while saving a cached
suggestion to the Redis server.</li>
</ul>
<h3 id="merino-web"><a class="header" href="#merino-web"><code>merino-web</code></a></h3>
<ul>
<li>
<p><code>INFO web.suggest.request</code> - A suggestion request is being processed. This
event will include fields for all relevant details of the request. <strong>Fields:</strong></p>
<ul>
<li><code>query</code> - If query logging is enabled, the text the user typed. Otherwise an
empty string.</li>
<li><code>country</code> - The country the request came from.</li>
<li><code>region</code> - The first country subdivision the request came from.</li>
<li><code>city</code> - The city the request came from.</li>
<li><code>dma</code> - A US-only location description that is larger than city and smaller
than states, but does not align to political borders.</li>
<li><code>agent</code> - The original user agent.</li>
<li><code>os_family</code> - Parsed from the user agent. One of &quot;windows&quot;, &quot;macos&quot;,
&quot;linux&quot;, &quot;ios&quot;, &quot;android&quot;, &quot;chrome os&quot;, &quot;blackberry&quot;, or &quot;other&quot;.</li>
<li><code>form_factor</code> - Parsed from the user agent. One of &quot;desktop&quot;, &quot;phone&quot;,
&quot;tablet&quot;, or &quot;other&quot;</li>
<li><code>browser</code> - The browser and possibly version detected. Either &quot;Firefox(XX)&quot;
where XX is the version, or &quot;Other&quot;.</li>
<li><code>rid</code> - The request ID.</li>
<li><code>accepts_english</code> - True if the user's Accept-Language header includes an
English locale, false otherwise.</li>
<li><code>requested_providers</code> - A comma separated list of providers requested via
the query string, or an empty string if none were requested (in which case
the default values would be used).</li>
<li><code>client_variants</code> - Any client variants sent to Merino in the query string.</li>
</ul>
</li>
<li>
<p><code>INFO web.configuring-suggesters</code> - A web worker is starting to configure
local suggesters, which may take some seconds and require network traffic to
synchronize data.</p>
</li>
<li>
<p><code>ERROR web.suggest.setup-error</code> - There was an error while setting up
configuration providers. This may be temporary, and future requests will
attempt to configure providers again.</p>
</li>
<li>
<p><code>ERROR web.suggest.error</code> - There was an error while providing suggestions
from an otherwise set-up provider. This may represent a network or
configuration error.</p>
</li>
<li>
<p><code>ERROR dockerflow.error_endpoint</code> - The <code>__error__</code> endpoint of the server was
called. This is used to test our error reporting system. It is not a cause for
concern, unless we receive a large amount of these records, in which case some
outside service is likely malicious or misconfigured.</p>
</li>
</ul>
<h2 id="metrics-1"><a class="header" href="#metrics-1">Metrics</a></h2>
<blockquote>
<p>A note on timers: Statsd timers are measured in milliseconds, and are reported
as integers (at least in Cadence). Milliseconds are often not precise enough
for the tasks we want to measure in Merino. Instead we use generic histograms
to record microsecond times. Metrics recorded in this way should have <code>-us</code>
appended to their name, to mark the units used (since we shouldn't put the
proper unit μs in metric names).</p>
</blockquote>
<ul>
<li>
<p><code>startup</code> - A counter incremented at startup, right after metrics are
initialized, to signal a successful metrics system initialization.</p>
</li>
<li>
<p><code>client_variants.&lt;variant_name&gt;</code> - A counter incremented for each client
variant present in a query request, incremented when the response is assembled
with the suggestions.</p>
</li>
<li>
<p><code>request.suggestion-per</code> - A histogram that reports the number of suggestions
in a response for a given query.</p>
</li>
<li>
<p><code>keywordfilter.match</code> - Report the number of suggestions filtered by the
filter with the given ID.</p>
<p><strong>Tags:</strong></p>
<ul>
<li><code>id</code> - The filter that was matched.</li>
</ul>
</li>
<li>
<p><code>adm.rs.provider.duration-us</code> - A histogram that records the amount of time,
in microseconds, that the adM Remote Settings provider took to generate
suggestions.</p>
<p><strong>Tags:</strong></p>
<ul>
<li><code>accepts-english</code> - If the request included an <code>Accept-Language</code> header that
accepted any <code>en-*</code> locale. Only requests that do are provided with
suggestions.</li>
</ul>
</li>
<li>
<p><code>cache.memory.duration-us</code> - A histogram that records the amount of time, in
microseconds, that the memory cache took to provide a suggestion. Includes the
time it takes to fallback to the inner provider for cache misses and errors.</p>
<p><strong>Tags:</strong></p>
<ul>
<li><code>cache-status</code> - If the response was pulled from the cache or regenerated.
<code>&quot;hit&quot;</code>, <code>&quot;miss&quot;</code>, <code>&quot;error&quot;</code>, or <code>&quot;none&quot;</code>.</li>
</ul>
</li>
<li>
<p><code>cache.memory.hit</code> - A counter that is incremented every time the in-memory
cache is queried and a cached suggestion is found.</p>
</li>
<li>
<p><code>cache.memory.miss</code> - A counter that is incremented every time the in-memory
cache is queried and a cached suggestion is not found.</p>
</li>
<li>
<p><code>cache.memory.pointers-len</code> - A gauge representing the number of entries in
the first level of hashing in the in-memory deduped hashmap.</p>
</li>
<li>
<p><code>cache.memory.storage-len</code> - A gauge representing the number of entries in the
second level of hashing in the in-memory deduped hashmap.</p>
</li>
<li>
<p><code>cache.redis.duration-us</code> - A histogram that records the amount of time, in
microseconds, that the Redis cache took to provide a suggestion. Includes the
time it takes to fallback to the inner provider for cache misses and errors.</p>
<p><strong>Tags:</strong></p>
<ul>
<li><code>cache-status</code> - If the response was pulled from the cache or regenerated.
<code>&quot;hit&quot;</code>, <code>&quot;miss&quot;</code>, <code>&quot;error&quot;</code>, or <code>&quot;none&quot;</code>.</li>
</ul>
</li>
<li>
<p><code>cache.redis.hit</code> - A counter that is incremented every time the redis cache
is queried and a cached suggestion is found.</p>
</li>
<li>
<p><code>cache.redis.miss</code> - A counter that is incremented every time the redis cache
is queried and a cached suggestion is not found.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-documentation-for-working-on-merino"><a class="header" href="#developer-documentation-for-working-on-merino">Developer documentation for working on Merino</a></h1>
<h2 id="tldr"><a class="header" href="#tldr">tl;dr</a></h2>
<p>Here are some useful commands when working on Merino.</p>
<p>Run the main app</p>
<pre><code class="language-shell">$ docker-compose -f dev/docker-compose.yaml up -d
$ cargo run -p merino
</code></pre>
<p>Run tests</p>
<pre><code class="language-shell">$ docker-compose -f dev/docker-compose.yaml up -d
$ cargo test
</code></pre>
<p>Run dependency servers</p>
<pre><code class="language-shell">$ cd dev
$ docker-compose up
</code></pre>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>You can generate documentation, both code level and book level, for Merino and
all related crates by running <code>./dev/make-all-docs.sh</code>. You'll need <a href="https://rust-lang.github.io/mdBook/">mdBook</a>,
which you can get with <code>cargo install mdbook</code>.</p>
<p><a href="dev//merino/rustdoc/">Pre-built code docs are also available</a>.</p>
<h2 id="local-configuration"><a class="header" href="#local-configuration">Local configuration</a></h2>
<p>The default configuration of Merino is <code>development</code>, which has human-oriented
logging and debugging enabled. For settings that you wish to change in the
development configuration, you have two options, listed below.</p>
<blockquote>
<p>For full details, make sure to check out the documentation for
<a href="dev/../ops.html">Merino's setting system</a>.</p>
</blockquote>
<h3 id="update-the-defaults"><a class="header" href="#update-the-defaults">Update the defaults</a></h3>
<p>If the change you want to make makes the system better for most development
tasks, consider adding it to <code>config/development.yaml</code>, so that other developers
can take advantage of it. You can look at <code>config/base.yaml</code>, which defines all
requires configuration, to see an example of the structure.</p>
<p>It is not suitable to put secrets in <code>config/development.yaml</code>.</p>
<h3 id="create-a-local-override"><a class="header" href="#create-a-local-override">Create a local override</a></h3>
<p>For local changes to adapt to your machine or tastes, you can put the
configuration in <code>config/local.yaml</code>. These file doesn't exist by default. These
changes won't be a part of the git history, so it is safe to put secrets here,
if needed. Importantly, it should never be <em>required</em> to have a <code>local.yaml</code> to
run Merino in a development setting.</p>
<h2 id="repository-structure"><a class="header" href="#repository-structure">Repository structure</a></h2>
<p>This project is structured as a <a href="https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html">Cargo Workspace</a> that contains one crate for
each broad area of behavior for Merino. This structure is advantageous because
the crates can be handled either individually or as a group. When compiling,
each crate can be compiled in parallel, where dependencies allow, and when
running tests, each test suite can be run separately or together. This also
provides an advantage if we choose to re-use any of these crates in other
projects, or if we publish the crates to Crates.io.</p>
<h2 id="project-crates"><a class="header" href="#project-crates">Project crates</a></h2>
<p>This is a brief overview of the crates found in the repository. For more
details, see the specific crate docs.</p>
<h3 id="merino-1"><a class="header" href="#merino-1"><a href="dev/../rustdoc/merino/"><code>merino</code></a></a></h3>
<p>This is the main Merino application, and one of the <em>binary</em> crates in the
repository. It brings together and configures the other crates to create a
production-like environment for Firefox Suggest.</p>
<h3 id="merino-settings"><a class="header" href="#merino-settings"><a href="dev/../rustdoc/merino_settings/"><code>merino-settings</code></a></a></h3>
<p>This defines and documents the settings of the application. These settings
should be initialized by one of the <em>binary</em> crates, and passed into the other
crates to configure them.</p>
<h3 id="merino-web-1"><a class="header" href="#merino-web-1"><a href="dev/../rustdoc/merino_web/"><code>merino-web</code></a></a></h3>
<p>This crate provides an HTTP API to access Merino, including providing
observability into the running of the application via that API.</p>
<h3 id="merino-suggest"><a class="header" href="#merino-suggest"><a href="dev/../rustdoc/merino_suggest/"><code>merino-suggest</code></a></a></h3>
<p>This is a <em>domain</em> crate that defines the data model and traits needed to
provide suggestions to Firefox.</p>
<h3 id="merino-cache-1"><a class="header" href="#merino-cache-1"><a href="dev/../rustdoc/merino_cache/"><code>merino-cache</code></a></a></h3>
<p>This crate contains domain models and behavior for Merino's caching
functionality.</p>
<h3 id="merino-adm-1"><a class="header" href="#merino-adm-1"><a href="dev/../rustdoc/merino_adm/"><code>merino-adm</code></a></a></h3>
<p>This crate provides integration with the AdMarketplace APIs, and implements the
traits from <code>merino-suggest</code>.</p>
<h3 id="merino-showroom"><a class="header" href="#merino-showroom"><a href="dev/./showroom.html"><code>merino-showroom</code></a></a></h3>
<p>This is not a Rust crate, but instead a small Javascript application. It can be
used to test Merino during development and demos.</p>
<h3 id="merino-integration-tests"><a class="header" href="#merino-integration-tests"><a href="dev/../rustdoc/merino_integration_tests/"><code>merino-integration-tests</code></a></a></h3>
<p>This crate is a separate test system. It works much like <code>merino</code>, in that it
brings together the other crates to produce a complete Merino environment.
However, this binary crate produces an application that exercise the service as
a whole, instead of providing a server to manual test against.</p>
<h3 id="merino-integration-tests-macro"><a class="header" href="#merino-integration-tests-macro"><a href="dev/../rustdoc/merino_integration_tests_macro/"><code>merino-integration-tests-macro</code></a></a></h3>
<p>This crate provides a procmacro used in <code>merino-integration-tests</code>. Rust
requires that procmacros be in their own crate.</p>
<h2 id="recommended-tools"><a class="header" href="#recommended-tools">Recommended Tools</a></h2>
<ul>
<li><a href="https://rust-analyzer.github.io/">rust-analyzer</a> - IDE-like tools for many editors. This provides easy access
to type inference and documentation while editing Rust code, which can make
the development process much easier.</li>
<li><a href="https://crates.io/crates/cargo-watch">cargo-watch</a> - A Cargo subcommand that re-runs a task when files change.
Very useful for things like <code>cargo watch -x clippy</code> or
<code>cargo watch -x &quot;test -- merino-adm&quot;</code>.</li>
</ul>
<h2 id="recommended-reading"><a class="header" href="#recommended-reading">Recommended Reading</a></h2>
<p>These works have influenced the design of Merino.</p>
<ul>
<li>The Contextual Services
<a href="https://github.com/mozilla-services/skeleton/">Skeleton Actix project</a></li>
<li><a href="https://www.zero2prod.com/">Zero to Production in Rust</a> by Luca Palmieri</li>
<li><a href="https://www.youtube.com/watch?v=rAF8mLI0naQ">Error Handling Isn't All About Errors</a>,
by Jane &quot;<a href="https://twitter.com/yaahc_/">yaahc</a>&quot; Lusby, from RustConf 2020.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-dependencies"><a class="header" href="#development-dependencies">Development Dependencies</a></h1>
<p>Merino uses a Redis-based caching system, and so requires a Redis instance to
connect to.</p>
<p>To make things simple, Redis (and any future service dependencies) can be
started with Docker Compose, using the <code>docker-compose.yaml</code> file in the <code>dev/</code>
directory. Notably, this does not run any Merino components that have source
code in this repository.</p>
<pre><code class="language-shell">$ cd dev
$ docker-compose up
</code></pre>
<p>This Dockerized set up is optional. Feel free to run the dependent services by
any other means as well.</p>
<h3 id="dev-helpers"><a class="header" href="#dev-helpers">Dev Helpers</a></h3>
<p>The docker-compose setup also includes some services that can help during
development.</p>
<ul>
<li>Redis Commander, http://localhost:8081 - Explore the Redis database started
above.</li>
<li>Statsd Logger - Receives statsd metrics emitted by Merino (and any thing else
on your system using statsd). Available through docker-compose logs. For
example with <code>docker-compose logs -f statsd-logger</code>.</li>
<li>Kinto - Runs a local Remote Settings service that is used by &quot;merino-adm&quot;.</li>
<li>Kinto-attachments - Provides the attachment feature for the &quot;Kinto&quot; service.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logging-and-metrics"><a class="header" href="#logging-and-metrics">Logging and Metrics</a></h1>
<p>To get data out of Merino and into observable systems, we use <em>metrics</em> and
<em>logging</em>. Each has a unique use case. Note that in general, because of the scale
we work at, adding a metric or log event in production is not free, and if we
are careless can end up costing quite a bit. Record what is needed, but don't go
over board.</p>
<p>All data collection that happens in production (logging at INFO, WARN, or ERROR
levels; and metrics) should be documented in <a href="dev/../data.html"><code>docs/data.md</code></a>.</p>
<h2 id="logging-1"><a class="header" href="#logging-1">Logging</a></h2>
<p>Merino uses <a href="https://crates.io/crates/tracing">Tracing</a> for logging, which &quot;is a framework for instrumenting
Rust programs to collect structured, event-based diagnostic information&quot;. Below
are some notes about using Tracing in Merino, but consider reading their docs
for more information.</p>
<p>The basic way to interact with tracing is via the macros <code>tracing::error!</code>,
<code>tracing::warn!</code>, <code>tracing::info!</code>, <code>tracing::debug!</code>, and <code>tracing::trace!</code>.</p>
<p>Tracing can output logs in various formats, including a JSON format for
production. In these docs we'll use a pretty, human readable format that spreads
logs over multiple lines to include more information in a readable way.</p>
<h3 id="types"><a class="header" href="#types">Types</a></h3>
<p>MozLog requires that all messages have a <code>type</code> value. If one is not provided,
our logging systems use <code>&quot;&lt;unknown&gt;&quot;</code> as a type value. All <code>INFO</code>, <code>WARN</code>, and
<code>ERROR</code> messages should have a type field, specified like:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>tracing::warn!(
  r#type = &quot;suggest.providers.multi.created-empty&quot;,
  id = %provider.id,
  &quot;An empty MultiProvider was created&quot;
);
<span class="boring">}
</span></code></pre></pre>
<p>In general, the log <em>message</em> (&quot;An empty MultiProvider was created&quot;) and the log
<em>type</em> should both tell the reader what has happened. The difference is that the
message is for humans and the type is for machines.</p>
<p>Type should be a dotted path to the file you're working in, with any <code>merino-</code>
prefix removed, ending in a code specific to the error. This does not strictly
need to follow the file system hierarchy, and stability over time is more
important than refactoring.</p>
<h3 id="levels"><a class="header" href="#levels">Levels</a></h3>
<p>Tracing provides five log levels that should be familiar. This is what we mean
by them in Merino:</p>
<ul>
<li>
<p><code>ERROR</code> - There was a problem, and the task was not completable. This usually
results in a 500 being sent to the user. All error logs encountered in
production are reported to Sentry and should be considered a bug. If it isn't
a bug, it shouldn't be logged as an error.</p>
</li>
<li>
<p><code>WARNING</code> - There was a problem, but the task was able to recover. This
doesn't usually affect what the user sees. Warnings are suitable for
unexpected but &quot;in-spec&quot; issues, like a sync job not returning an empty set or
using a deprecated function. These are not reported to Sentry.</p>
</li>
<li>
<p><code>INFO</code> - This is the default level of the production service. Use for logging
that something happened that isn't a problem and we care about in production.
This is the level that Merino uses for it's one-per-request logs and sync
status messages. Be careful adding new per-request logs at this level, as they
can be expensive.</p>
</li>
<li>
<p><code>DEBUG</code> - This is the default level for developers running code locally. Use
this to give insight into how the system is working, but keep in mind that
this will be on by default, so don't be too noisy. Generally this should
summarize what's happening, but not give the small details like a log line for
every iteration of a loop. Since this is off in production, there are no cost
concerns.</p>
</li>
<li>
<p><code>TRACE</code> - This level is hidden by default in all environments, including
tests. Add this for very detailed logs of what specific functions or objects
are doing. To see these logs, you'll need to turn up the logging level for the
area of the code you're in. See <a href="dev/../ops.html#logging">the logging settings</a> for
more details. If you add logs to figure out why something isn't working or why
a test isn't passing, do so at the <code>TRACE</code> level, and consider leaving them in
the code for future debuggers.</p>
</li>
</ul>
<h3 id="including-data"><a class="header" href="#including-data">Including data</a></h3>
<p>If you want to log something that includes the contents of a variable, in other
libraries you might use string interpolation like
<code>tracing::error!(&quot;could not find file: {}&quot;, file_path)</code>. This works in Tracing,
but there is a better way:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>tracing::error!(?file_path, r#type = &quot;file_handler.missing&quot;, &quot;could not find file&quot;);
<span class="boring">}
</span></code></pre></pre>
<p>This would produce a log event like</p>
<pre><code class="language-log">Oct 27 15:51:35.134 ERROR merino: could not find file, file_path: &quot;an/important/path.txt&quot;, type: &quot;file_handler.missing&quot;
  at merino/src/file_handler.rs:65
  in merino::file_handler::load
</code></pre>
<p>By including the <code>file_path</code> before the log line, it is included as structured
data. This will be machine-readable and can be used for better parsing down the
line. In general, you should prefer structured logging for including data in log
events.</p>
<h2 id="metrics-2"><a class="header" href="#metrics-2">Metrics</a></h2>
<p>Metrics are handled by <a href="https://crates.io/crates/cadence">Cadence</a> in [Statsd][] format
https://www.datadoghq.com/blog/statsd/.</p>
<p>Unlike logging, the primary way that metrics reporting can cost a lot is in
<em>cardinality</em>. The number of metric IDs we have and the combination of tag
values that we supply. Often the number of individual events doesn't matter as
much, since multiple events are aggregated together.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-strategies"><a class="header" href="#testing-strategies">Testing strategies</a></h1>
<p>There are four major testing strategies used in this repository: unit tests,
Rust integration tests, Python contract tests, and Python load tests.</p>
<h2 id="unit-tests"><a class="header" href="#unit-tests">Unit Tests</a></h2>
<p>Unit tests should appear close to the code they are testing, using standard Rust
unit tests. This is suitable for testing complex behavior at a small scale, with
fine grained control over the inputs.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn add_two(n: u32) -&gt; u32 {
    n + 2
}

#[cfg(test)]
mod tests {
    #[test]
    fn add_two_works() {
        assert_eq!(add_two(3), 5, &quot;it should work&quot;);
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="integration-tests"><a class="header" href="#integration-tests">Integration tests</a></h2>
<p>Many behaviors are difficult to test as unit tests, especially details like the
URLs we expose via the web service. To test these parts of Merino, we have
<a href="dev/../../../merino_integration_tests/"><code>merino-integration-tests</code></a>, which starts a configurable instance
of Merino with mock data sources. HTTP requests can then be made to that server
in order to test its behavior.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[actix_rt::test]
async fn lbheartbeat_works() {
    merino_test(
        |_| (),
        |TestingTools { test_client, .. }| async move {
            let response = test_client
                .get(&quot;/__lbheartbeat__&quot;)
                .send()
                .await
                .expect(&quot;failed to execute request&quot;);

            assert_eq!(response.status(), StatusCode::OK);
            assert_eq!(response.content_length(), Some(0));
        },
    )
    .await
}
<span class="boring">}
</span></code></pre></pre>
<p>For more details, see the documentation of the <code>merino-integration-tests</code> crate.</p>
<h2 id="contract-tests"><a class="header" href="#contract-tests">Contract tests</a></h2>
<p>The tests in the <code>test-engineering/contract-tests</code> directory are contract tests
that consume Merino's APIs using more opaque techniques. These tests run against
a Docker container of the service, specify settings via environment variables,
and operate on the HTTP API layer only and as such are more concerned with
external contracts and behavior. The contract tests cannot configure the server
per test.</p>
<p>For more details see the README.md file in the <code>test-engineering/contract-tests</code>
directory.</p>
<h2 id="load-tests"><a class="header" href="#load-tests">Load tests</a></h2>
<p>The tests in the <code>test-engineering/load-tests</code> directory are load tests that
spawn multiple HTTP clients that consume Merino's API. These tests do not run on
CI. We run them manually to simulate real-world load on the Merino infrastructure.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="merino-admin"><a class="header" href="#merino-admin">Merino Admin</a></h1>
<p>This is a separate site intended to be deployed along side Merino. It manages
dynamic settings that will (some day) allow Merino's behavior to be changed at
runtime.</p>
<p>To use merino-admin, you'll need a Python development environment, and
<a href="https://python-poetry.org/">Poetry</a>. With that ready, you can set up the Django site:</p>
<pre><code class="language-shell"># From the repository root
$ cd merino-admin
$ poetry shell
$ poetry install
$ ./manage.py migrate
$ ./manage.py createsuperuser
</code></pre>
<p>and run the admin site:</p>
<pre><code class="language-shell">$ ./manage.py runserver
</code></pre>
<p>This will start a development server that reloads on changes to the files. You
can access the editing part of the site at
[localhost:8000/admin][http://localhost:8000/admin].</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="merino-showroom-1"><a class="header" href="#merino-showroom-1">Merino Showroom</a></h1>
<p>Showroom is a small JS demo to interact with Merino independent of the
implementation in Firefox's UI, for testing and demonstration purposes.</p>
<p>To use the showroom, first start an instance of <code>merino</code> with
<code>cargo run -p merino</code>. Then, in another terminal start Showroom by running:</p>
<pre><code class="language-shell"># From the repository root
$ cd merino-showroom
$ npm install
$ npm run dev
</code></pre>
<p>This will start a server on <a href="http://localhost:3000">localhost:3000</a> that is
configured to connect to the default configuration of <code>merino-web</code>.</p>
<p>Note, Node 16 or higher is required to run Showroom.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="choosing-a-logging-library-for-merino"><a class="header" href="#choosing-a-logging-library-for-merino">Choosing a logging library for Merino</a></h1>
<ul>
<li>Status: accepted</li>
<li>Date: 2021-05-11</li>
</ul>
<p>Tracking issue:
<a href="https://github.com/mozilla-services/merino/issues/15">mozilla-services/merino#15</a></p>
<h2 id="context-and-problem-statement"><a class="header" href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>Merino needs a system to produce logging. Rust has several options to do this,
with no clear winner. What library should Merino use?</p>
<h3 id="the-log-crate"><a class="header" href="#the-log-crate">The <code>log</code> Crate</a></h3>
<p>There is a de facto standard logging library for Rust,
<a href="https://crates.io/crates/log"><code>log</code></a>. It is an important part of the decision,
but it is not a solution to the problem: it is a logging <em>facade</em> that provides
a way for libraries to produce their own logs, but does not provide any logging
capabilities itself. Without a logger crate to use it with, the logs compile
away to nothing.</p>
<h2 id="decision-drivers"><a class="header" href="#decision-drivers">Decision Drivers</a></h2>
<ul>
<li>Sentry integration should be available</li>
<li>MozLog format should be supported</li>
<li>There should be both human and machine friendly logging output options.</li>
<li>Library compatibility</li>
</ul>
<h2 id="considered-options"><a class="header" href="#considered-options">Considered Options</a></h2>
<ol>
<li><a href="https://crates.io/crates/slog">slog</a></li>
<li><a href="https://crates.io/crates/tracing">tracing</a></li>
</ol>
<ul>
<li>Something from the <code>log</code> ecosystem</li>
</ul>
<h2 id="decision-outcome"><a class="header" href="#decision-outcome">Decision Outcome</a></h2>
<p>Option 2 - Tracing. Although Slog has more momentum at this time, Tracing sets
us up for a better set of tools long term.</p>
<h2 id="pros-and-cons-of-the-options"><a class="header" href="#pros-and-cons-of-the-options">Pros and Cons of the Options <!-- optional --></a></h2>
<h3 id="option-1---slog"><a class="header" href="#option-1---slog">Option 1 - Slog</a></h3>
<blockquote>
<p><code>slog</code> is an ecosystem of reusable components for structured, extensible,
composable and contextual logging for Rust.</p>
</blockquote>
<p>Slog's first release was 0.1.0 in June of 2016, and it's 1.0 release was in
September of 2016.</p>
<p>To use it, developers create logger objects that provide methods to produce log
lines and create sub-loggers. These loggers must be passed to lower level code
explicitly to be used.</p>
<p>Slog is compatible with the de facto <code>log</code> crate. Log lines emitted using that
system (such as by libraries) can be routed to a logger object, with no loss of
detail. Few libraries use slog directly, and none of the libraries that are
currently used in Merino do at all. Since libraries aren't using <code>slog</code>, it will
be harder to make them participate in the logging hierarchy.</p>
<p>Structured logging is supported. Logs can carry associated data, which can aid
in the machine readability of logs.</p>
<p>The tree of loggers is built explicitly through the loggers objects, and
subloggers must be aware of superloggers, since the only way to get a sublogger
is to call a method on a logger. This separates the logging structure from the
call stack, but makes it awkward to recover that information should it be
helpful. This means that logging generally has to be passed as arguments to many
functions, making the tree of loggers less flexible.</p>
<p>The Sentry library for Rust has support for slog. There is a a
<a href="https://crates.io/crates/slog-mozlog-json">MozLog crate</a> for slog that Mozilla
wrote.</p>
<ul>
<li>Good, because structured logging helps provide more useful logs.</li>
<li>Good, because it has Sentry integration.</li>
<li>Good, because it already has MozLog integration.</li>
<li>Bad, because it has little library support.</li>
<li>Bad, because explicitly building the logging tree is rigid.</li>
</ul>
<h3 id="option-2---tracing"><a class="header" href="#option-2---tracing">Option 2 - Tracing</a></h3>
<blockquote>
<p><code>tracing</code> is a framework for instrumenting Rust programs to collect
structured, event-based diagnostic information.</p>
</blockquote>
<p>Tracing's first release was 0.0.0 in November of 2017. It has not had a 1.0
release. It's latest release is 0.1.26, published April 2021.</p>
<p>To use it, developers set up a global or scope-based subscriber of logs, which
collects <em>spans</em> and <em>events</em> that are generated in the code. Spans can be
<code>enter</code>ed and <code>exit</code>ed. During the time between these, all spans and events are
associated with the entered span as their parent. This association happens
explicitly, and can cross call boundaries. However, spans can be entered and
exited in more fine grained ways if needed.</p>
<p>Tracing is compatible with the de facto <code>log</code> crate. Log lines emitted using
that system are seen as events in Tracing, with no loss of detail.</p>
<p>Structured logging is supported. Both spans and events can carry associated
data. This data can be accessed hierarchically, building up a context of
execution.</p>
<p>The tree of spans is built by entering spans. Loggers do not have to be aware of
their parents, their logs are placed in the context of whatever set of spans has
been entered at that moment. because [ one like we did with slog.</p>
<p>Tracing is developed as a part of the Tokio ecosystem, the same that our web
framework (Actix), http client (Reqwest), and async runtime (Tokio) are
developed under. It has some library support. Additionally, since the tree of
spans is built more implicitly, libraries that use the <code>log</code> facade can
participate in our structured logging.</p>
<ul>
<li>Good, because structured logging helps provide more useful logs.</li>
<li>Good, because it has good integration into the libraries we use.</li>
<li>Good, because implicitly building the logging hierarchy and context is
flexible.</li>
<li>Bad, because it lacks Sentry support.</li>
<li>Bad, because it lacks MozLog support.</li>
</ul>
<h3 id="option-3---something-in-the-log-ecosystem"><a class="header" href="#option-3---something-in-the-log-ecosystem">Option 3 - Something in the <code>log</code> ecosystem</a></h3>
<p>This option was not considered deeply because <code>log</code> does not support structured
logging. Not being able to attach concrete data to logs makes much of the
logging tasks much harder.</p>
<ul>
<li>Bad, because it lacks structured logging.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>/*!</p>
<h1 id="choosing-a-logging-library-for-merino-1"><a class="header" href="#choosing-a-logging-library-for-merino-1">Choosing a logging library for Merino</a></h1>
<ul>
<li>Status: accepted</li>
<li>Date: 2021-07-28</li>
</ul>
<p>Tracking issue: N/A</p>
<h2 id="context-and-problem-statement-1"><a class="header" href="#context-and-problem-statement-1">Context and Problem Statement</a></h2>
<p>Merino needs a way to generate cache keys for items it will store in the cache.
A natural way to do this is by hashing the input, and using the result of the
hash for the cache key. There are many hash keys available. Which one should
Merino use?</p>
<h2 id="decision-drivers-1"><a class="header" href="#decision-drivers-1">Decision Drivers</a></h2>
<ul>
<li>For Merino's common workloads, generating a hash should be low latency.</li>
<li>The items that Merino hashes are relatively small, a few dozen bytes plus the
user's query.</li>
<li>Hashes should be stable across time (on multiple version of Merino) and space
(on multiple instances of the same version of Merino).</li>
<li>HashDoS protection is not a concern.</li>
</ul>
<h2 id="considered-options-1"><a class="header" href="#considered-options-1">Considered Options</a></h2>
<ol>
<li><a href="https://en.wikipedia.org/wiki/SipHash">SipHash</a></li>
<li><a href="https://crates.io/crates/ahash">aHash</a></li>
<li><a href="https://crates.io/crates/rustc-hash">rustc-hash (aka FxHasher)</a></li>
<li><a href="https://crates.io/crates/highway">HighwayHash</a></li>
<li>sha256 or similar</li>
<li><a href="https://github.com/BLAKE3-team/BLAKE3">Blake3</a></li>
</ol>
<h2 id="decision-outcome-1"><a class="header" href="#decision-outcome-1">Decision Outcome</a></h2>
<p>Chosen option: option 6, Blake3, because it is network-safe, and very fast.</p>
<h2 id="pros-and-cons-of-the-options-1"><a class="header" href="#pros-and-cons-of-the-options-1">Pros and Cons of the Options</a></h2>
<h3 id="option-1---siphash"><a class="header" href="#option-1---siphash">Option 1 - SipHash</a></h3>
<ul>
<li><a href="adrs/">https://en.wikipedia.org/wiki/SipHash</a></li>
<li><a href="adrs/">https://doc.rust-lang.org/std/hash/struct.SipHasher.html</a></li>
</ul>
<p>SipHash is a non-cryptographic hash algorithm used by default for Rust's hashing
needs, such as HashMaps. It is designed primarily to be resistent against
&quot;HashDoS&quot; attacks, in which an attacker can force hash collisions in a system
and overwhelm data structures like hashmaps and caches. It is faster than most
cryptographic hashes, such as sha256, but is generally slower than other hashes
considered.</p>
<p>In Rust's standard library, the standard way to use SipHash is with
<code>std::collections::hash_map::DefaultHasher</code>, which is not guaranteed to produce
stable output over time. Specifically, DefaultHasher may change to hashing
algorithm besides SipHash in the future.</p>
<ul>
<li>Good, because it is widely tested by Rust</li>
<li>Good, because it is already available in the standard library</li>
<li>Bad, because it spends resources on hashdos protection, which we don't need</li>
<li>Bad, because Rust's <code>DefaultHash</code> is the normal way to use it, and
<code>DefaultHash</code> may change in the future.</li>
</ul>
<h3 id="option-2---ahash"><a class="header" href="#option-2---ahash">Option 2 - aHash</a></h3>
<ul>
<li><a href="adrs/">https://crates.io/crates/ahash</a></li>
</ul>
<p>AHash is designed with the explicit purpose of being the fastest HashDOS
resistant hash available in Rust. It is also designed specifically to be used
for in-memory hashmaps, and is not guaranteed to be stable over time or space.</p>
<p>This would be a viable candidate for any case where Merino uses in-memory
hashmaps that need high performance, but is not suitable for network hashing,
such as for Redis keys.</p>
<ul>
<li>Good, because it is very fast</li>
<li>Bad, because it is not network-safe</li>
</ul>
<h3 id="option-3---rustc-hash-aka-fxhash"><a class="header" href="#option-3---rustc-hash-aka-fxhash">Option 3 - rustc-hash aka FxHash</a></h3>
<p><a href="adrs/">https://crates.io/crates/rustc-hash</a></p>
<p>This is the hashing algorithm used internally by the Rust compiler, and is used
in some places in Firefox. It is also not designed to be network safe, though it
may be by accident. It is comparable in speed to aHash, depending on the input.
It is not resistant against HashDoS attacks, since it is not a keyed hashing
algorithm.</p>
<p>Notably, the aHash hash comparison suite claims that it is easy to accidentally
produce self-DoS conditions with this hashing algorithm, if the hash inputs are
not well chosen.</p>
<ul>
<li>Good, because it is used in rustc and Firefox</li>
<li>Good, because it is relatively fast</li>
<li>Bad, because it is not intended to be network safe</li>
<li>Bad, because of claims about extreme weakness against DoS, including self-DoS</li>
</ul>
<h3 id="option-4---highwayhash"><a class="header" href="#option-4---highwayhash">Option 4 - HighwayHash</a></h3>
<ul>
<li><a href="adrs/">https://crates.io/crates/highway</a></li>
<li><a href="adrs/">https://github.com/google/highwayhash</a></li>
</ul>
<p>HighwayHash is an algorithm developed by Google designed to be network safe,
strong against DoS attacks, and SIMD-optimized. It is recommended by
<a href="https://crates.io/crates/ahash">the aHash README</a> as a better choice in
&quot;network use or in applications which persist hashed values&quot;.</p>
<p>Notably, HighwayHash is relatively slow for small hash inputs, but relatively
fast for larger ones (though still not as fast as most non-network-safe
algorithms). Merino's hash inputs are near the boundary where it starts to be
faster than it's competition.</p>
<p>There is a predecessor to HighwayHash, FarmHash (and CityHash before it), that
are faster for smaller inputs. However, the libraries for these aren't
maintained anymore.</p>
<ul>
<li>Good, because it is relatively fast</li>
<li>Good, because it is designed to be network-safe</li>
<li>Good, because it is a &quot;frozen&quot; by Google, and won't change in the future</li>
<li>Good, because it is actively maintained.</li>
<li>Bad, because it's relatively slow for smaller keys.</li>
</ul>
<h3 id="option-5---sha256-or-similar"><a class="header" href="#option-5---sha256-or-similar">Option 5 - sha256 or similar</a></h3>
<p>The SHA family of hashes are network and DoS safe. However, due to being
cryptographic hash functions are notably slower than non-cryptographic hashes.
For purposes where speed is not an issue, they are exceptionally safe and well
tested algorithms that should be considered.</p>
<ul>
<li>Good, because it is very safe</li>
<li>Good, because it is very widely used and studied</li>
<li>Bad, because it is slow</li>
<li>Bad, because we pay for unneeded features</li>
</ul>
<h3 id="option-6---blake3"><a class="header" href="#option-6---blake3">Option 6 - Blake3</a></h3>
<ul>
<li><a href="adrs/">https://github.com/BLAKE3-team/BLAKE3</a></li>
</ul>
<p>Blake3 is a cryptographic hash function designed to be highly parallizable and
extremely fast. Being a cryptographic hash, it is network-safe, and Hash-DoS
resistant. It is however much faster than most cryptographic algorithms,
competing with the other fast algorithms considered here. It is a relatively new
hash, first published in January of 2020.</p>
<ul>
<li>Good, because it is ver safe</li>
<li>Good, because it very fast</li>
<li>Good, because it can be parallizable for large payloads</li>
<li>Bad, because it is relatively young</li>
</ul>
<h2 id="other-resources"><a class="header" href="#other-resources">Other resources</a></h2>
<ul>
<li><a href="https://nnethercote.github.io/perf-book/hashing.html">The Rust Performance Book :: Hashing</a></li>
<li><a href="https://github.com/tkaitchuck/aHash/tree/master/compare">aHash's hash comparison suite</a></li>
<li><a href="https://en.wikipedia.org/wiki/SipHash">SipHash</a></li>
<li><a href="https://crates.io/crates/ahash">aHash</a></li>
<li><a href="https://crates.io/crates/rustc-hash">rustc-hash (aka FxHasher)</a></li>
<li><a href="https://crates.io/crates/highway">HighwayHash</a></li>
</ul>
<h3 id="benchmarking-results-for-hashing-128-byte-values"><a class="header" href="#benchmarking-results-for-hashing-128-byte-values">Benchmarking results for hashing 128 byte values</a></h3>
<p><img src="adrs/./images/hash-benchmarks.png" alt="Chart of the performance of various hashing libraries" /></p>
<p>*/</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
