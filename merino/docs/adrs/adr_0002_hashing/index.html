<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Choosing a logging library for Merino"><meta name="keywords" content="rust, rustlang, rust-lang, adr_0002_hashing"><title>merino::docs::adrs::adr_0002_hashing - Rust</title><link rel="stylesheet" type="text/css" href="../../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../../../../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../../../../ayu.css" disabled ><script id="default-settings"></script><script src="../../../../storage.js"></script><script src="../../../../crates.js"></script><noscript><link rel="stylesheet" href="../../../../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../../../../favicon.svg">
<link rel="alternate icon" type="image/png" href="../../../../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../../../../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../../../../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../../../../merino/index.html'><div class='logo-container rust-logo'><img src='../../../../rust-logo.png' alt='logo'></div></a><p class="location">Module adr_0002_hashing</p><div class="sidebar-elems"><p class="location"><a href="../../../index.html">merino</a>::<wbr><a href="../../index.html">docs</a>::<wbr><a href="../index.html">adrs</a></p><div id="sidebar-vars" data-name="adr_0002_hashing" data-ty="mod" data-relpath="../"></div><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu"><img src="../../../../brush.svg" width="18" height="18" alt="Pick another theme!"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" class="help-button">?</button>
                <a id="settings-menu" href="../../../../settings.html"><img src="../../../../wheel.svg" width="18" height="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Module <a href="../../../index.html">merino</a>::<wbr><a href="../../index.html">docs</a>::<wbr><a href="../index.html">adrs</a>::<wbr><a class="mod" href="">adr_0002_hashing</a><button id="copy-path" onclick="copy_path(this)">⎘</button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../../../../src/merino/docs/adrs/adr_0002_hashing.rs.html#1-163" title="goto source code">[src]</a></span></h1><div class="docblock"><h1 id="choosing-a-logging-library-for-merino" class="section-header"><a href="#choosing-a-logging-library-for-merino">Choosing a logging library for Merino</a></h1>
<ul>
<li>Status: accepted</li>
<li>Date: 2021-07-28</li>
</ul>
<p>Tracking issue: N/A</p>
<h2 id="context-and-problem-statement" class="section-header"><a href="#context-and-problem-statement">Context and Problem Statement</a></h2>
<p>Merino needs a way to generate cache keys for items it will store in the cache.
A natural way to do this is by hashing the input, and using the result of the
hash for the cache key. There are many hash keys available. Which one should
Merino use?</p>
<h2 id="decision-drivers" class="section-header"><a href="#decision-drivers">Decision Drivers</a></h2>
<ul>
<li>For Merino’s common workloads, generating a hash should be low latency.</li>
<li>The items that Merino hashes are relatively small, a few dozen bytes plus the
user’s query.</li>
<li>Hashes should be stable across time (on multiple version of Merino) and space
(on multiple instances of the same version of Merino).</li>
<li>HashDoS protection is not a concern.</li>
</ul>
<h2 id="considered-options" class="section-header"><a href="#considered-options">Considered Options</a></h2>
<ol>
<li><a href="https://en.wikipedia.org/wiki/SipHash">SipHash</a></li>
<li><a href="https://crates.io/crates/ahash">aHash</a></li>
<li><a href="https://crates.io/crates/rustc-hash">rustc-hash (aka FxHasher)</a></li>
<li><a href="https://crates.io/crates/highway">HighwayHash</a></li>
<li>sha256 or similar</li>
<li><a href="https://github.com/BLAKE3-team/BLAKE3">Blake3</a></li>
</ol>
<h2 id="decision-outcome" class="section-header"><a href="#decision-outcome">Decision Outcome</a></h2>
<p>Chosen option: option 6, Blake3, because it is network-safe, and very fast.</p>
<h2 id="pros-and-cons-of-the-options" class="section-header"><a href="#pros-and-cons-of-the-options">Pros and Cons of the Options</a></h2><h3 id="option-1---siphash" class="section-header"><a href="#option-1---siphash">Option 1 - SipHash</a></h3>
<ul>
<li><a href="">https://en.wikipedia.org/wiki/SipHash</a></li>
<li><a href="">https://doc.rust-lang.org/std/hash/struct.SipHasher.html</a></li>
</ul>
<p>SipHash is a non-cryptographic hash algorithm used by default for Rust’s hashing
needs, such as HashMaps. It is designed primarily to be resistent against
“HashDoS” attacks, in which an attacker can force hash collisions in a system
and overwhelm data structures like hashmaps and caches. It is faster than most
cryptographic hashes, such as sha256, but is generally slower than other hashes
considered.</p>
<p>In Rust’s standard library, the standard way to use SipHash is with
<code>std::collections::hash_map::DefaultHasher</code>, which is not guaranteed to produce
stable output over time. Specifically, DefaultHasher may change to hashing
algorithm besides SipHash in the future.</p>
<ul>
<li>Good, because it is widely tested by Rust</li>
<li>Good, because it is already available in the standard library</li>
<li>Bad, because it spends resources on hashdos protection, which we don’t need</li>
<li>Bad, because Rust’s <code>DefaultHash</code> is the normal way to use it, and
<code>DefaultHash</code> may change in the future.</li>
</ul>
<h3 id="option-2---ahash" class="section-header"><a href="#option-2---ahash">Option 2 - aHash</a></h3>
<ul>
<li><a href="">https://crates.io/crates/ahash</a></li>
</ul>
<p>AHash is designed with the explicit purpose of being the fastest HashDOS
resistant hash available in Rust. It is also designed specifically to be used
for in-memory hashmaps, and is not guaranteed to be stable over time or space.</p>
<p>This would be a viable candidate for any case where Merino uses in-memory
hashmaps that need high performance, but is not suitable for network hashing,
such as for Redis keys.</p>
<ul>
<li>Good, because it is very fast</li>
<li>Bad, because it is not network-safe</li>
</ul>
<h3 id="option-3---rustc-hash-aka-fxhash" class="section-header"><a href="#option-3---rustc-hash-aka-fxhash">Option 3 - rustc-hash aka FxHash</a></h3>
<p><a href="">https://crates.io/crates/rustc-hash</a></p>
<p>This is the hashing algorithm used internally by the Rust compiler, and is used
in some places in Firefox. It is also not designed to be network safe, though it
may be by accident. It is comparable in speed to aHash, depending on the input.
It is not resistant against HashDoS attacks, since it is not a keyed hashing
algorithm.</p>
<p>Notably, the aHash hash comparison suite claims that it is easy to accidentally
produce self-DoS conditions with this hashing algorithm, if the hash inputs are
not well chosen.</p>
<ul>
<li>Good, because it is used in rustc and Firefox</li>
<li>Good, because it is relatively fast</li>
<li>Bad, because it is not intended to be network safe</li>
<li>Bad, because of claims about extreme weakness against DoS, including self-DoS</li>
</ul>
<h3 id="option-4---highwayhash" class="section-header"><a href="#option-4---highwayhash">Option 4 - HighwayHash</a></h3>
<ul>
<li><a href="">https://crates.io/crates/highway</a></li>
<li><a href="">https://github.com/google/highwayhash</a></li>
</ul>
<p>HighwayHash is an algorithm developed by Google designed to be network safe,
strong against DoS attacks, and SIMD-optimized. It is recommended by
<a href="https://crates.io/crates/ahash">the aHash README</a> as a better choice in
“network use or in applications which persist hashed values”.</p>
<p>Notably, HighwayHash is relatively slow for small hash inputs, but relatively
fast for larger ones (though still not as fast as most non-network-safe
algorithms). Merino’s hash inputs are near the boundary where it starts to be
faster than it’s competition.</p>
<p>There is a predecessor to HighwayHash, FarmHash (and CityHash before it), that
are faster for smaller inputs. However, the libraries for these aren’t
maintained anymore.</p>
<ul>
<li>Good, because it is relatively fast</li>
<li>Good, because it is designed to be network-safe</li>
<li>Good, because it is a “frozen” by Google, and won’t change in the future</li>
<li>Good, because it is actively maintained.</li>
<li>Bad, because it’s relatively slow for smaller keys.</li>
</ul>
<h3 id="option-5---sha256-or-similar" class="section-header"><a href="#option-5---sha256-or-similar">Option 5 - sha256 or similar</a></h3>
<p>The SHA family of hashes are network and DoS safe. However, due to being
cryptographic hash functions are notably slower than non-cryptographic hashes.
For purposes where speed is not an issue, they are exceptionally safe and well
tested algorithms that should be considered.</p>
<ul>
<li>Good, because it is very safe</li>
<li>Good, because it is very widely used and studied</li>
<li>Bad, because it is slow</li>
<li>Bad, because we pay for unneeded features</li>
</ul>
<h3 id="option-6---blake3" class="section-header"><a href="#option-6---blake3">Option 6 - Blake3</a></h3>
<ul>
<li><a href="">https://github.com/BLAKE3-team/BLAKE3</a></li>
</ul>
<p>Blake3 is a cryptographic hash function designed to be highly parallizable and
extremely fast. Being a cryptographic hash, it is network-safe, and Hash-DoS
resistant. It is however much faster than most cryptographic algorithms,
competing with the other fast algorithms considered here. It is a relatively new
hash, first published in January of 2020.</p>
<ul>
<li>Good, because it is ver safe</li>
<li>Good, because it very fast</li>
<li>Good, because it can be parallizable for large payloads</li>
<li>Bad, because it is relatively young</li>
</ul>
<h2 id="other-resources" class="section-header"><a href="#other-resources">Other resources</a></h2>
<ul>
<li><a href="https://nnethercote.github.io/perf-book/hashing.html">The Rust Performance Book :: Hashing</a></li>
<li><a href="https://github.com/tkaitchuck/aHash/tree/master/compare">aHash’s hash comparison suite</a></li>
<li><a href="https://en.wikipedia.org/wiki/SipHash">SipHash</a></li>
<li><a href="https://crates.io/crates/ahash">aHash</a></li>
<li><a href="https://crates.io/crates/rustc-hash">rustc-hash (aka FxHasher)</a></li>
<li><a href="https://crates.io/crates/highway">HighwayHash</a></li>
</ul>
<h3 id="benchmarking-results-for-hashing-128-byte-values" class="section-header"><a href="#benchmarking-results-for-hashing-128-byte-values">Benchmarking results for hashing 128 byte values</a></h3>
<p><img src="./images/hash-benchmarks.png" alt="Chart of the performance of various hashing libraries" /></p>
</div></section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../../../../" data-current-crate="merino" data-search-index-js="../../../../search-index.js" data-search-js="../../../../search.js"></div>
    <script src="../../../../main.js"></script></body></html>