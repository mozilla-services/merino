<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Tests for Merino that work by reading from the external API only."><meta name="keywords" content="rust, rustlang, rust-lang, merino_integration_tests"><title>merino_integration_tests - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script id="default-settings" ></script><script src="../storage.js"></script><script src="../crates.js"></script><script defer src="../main.js"></script>
    <noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../merino_integration_tests/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><h2 class="location">Crate merino_integration_tests</h2><div class="block version"><div class="narrow-helper"></div><p>Version 0.5.1</p></div><div class="sidebar-elems"><a id="all-types" href="all.html"><p>See all merino_integration_tests's items</p></a><div class="block items"><ul><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#functions">Functions</a></li></ul></div><div id="sidebar-vars" data-name="merino_integration_tests" data-ty="mod" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="18" height="18" alt="Pick another theme!" src="../brush.svg"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../settings.html" title="settings"><img width="18" height="18" alt="Change settings" src="../wheel.svg"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">merino_integration_tests</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/merino_integration_tests/lib.rs.html#1-92" title="goto source code">[src]</a></span></h1><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Tests for Merino that work by reading from the external API only.</p>
<p>Since the URL endpoints Merino exposes to the world are its public API, and
other systems depend on them, the paths used in tests here are important
details, and used to keep compatibility.</p>
<p>This is structured as a separate crate so that it produces a single test
binary instead of one test per file like would happen if this were
<code>merino/tests/...</code>. This improves compilation and test times.</p>
<p>The primary tool used by tests is <a href="utils/test_tools/fn.merino_test.html" title="merino_test"><code>merino_test</code></a>, which creates mock
servers, sets up the application for testing, and provides helpers to inspect
the state of the app. It then calls the test function that is passed to it,
providing the above tools as an argument.</p>
<h2 id="examples" class="section-header"><a href="#examples">Examples:</a></h2>
<p>A realistic test:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">merino_integration_tests</span>::{<span class="ident">TestingTools</span>, <span class="ident">merino_test_macro</span>};

<span class="attribute">#[<span class="ident">merino_test_macro</span>(<span class="op">|</span><span class="ident">settings</span><span class="op">|</span> <span class="ident">settings</span>.<span class="ident">debug</span> <span class="op">=</span> <span class="bool-val">true</span>)]</span>
<span class="kw">async</span> <span class="kw">fn</span> <span class="ident">lbheartbeat_works</span>(<span class="ident">TestingTools</span> { <span class="ident">test_client</span>, .. }: <span class="ident">TestingTools</span>) {
   <span class="kw">let</span> <span class="ident">response</span> <span class="op">=</span> <span class="ident">test_client</span>
       .<span class="ident">get</span>(<span class="string">&quot;/__lbheartbeat__&quot;</span>)
       .<span class="ident">send</span>()
       .<span class="kw">await</span>
       .<span class="ident">expect</span>(<span class="string">&quot;failed to execute request&quot;</span>);

   <span class="macro">assert_eq!</span>(<span class="ident">response</span>.<span class="ident">status</span>(), <span class="ident">StatusCode::OK</span>);
   <span class="macro">assert_eq!</span>(<span class="ident">response</span>.<span class="ident">content_length</span>(), <span class="prelude-val">Some</span>(<span class="number">0</span>));
}</code></pre></div>
<p>Basic usage:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">merino_integration_tests</span>::{<span class="ident">merino_test_macro</span>, <span class="ident">TestingTools</span>};

<span class="attribute">#[<span class="ident">merino_test_macro</span>]</span>
<span class="kw">async</span> <span class="kw">fn</span> <span class="ident">test_function</span>(<span class="ident">TestingTools</span> { <span class="ident">test_client</span>, .. }: <span class="ident">TestingTools</span>) {
    <span class="comment">// test using test_client</span>
}</code></pre></div>
<p>Settings can be customized:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">merino_integration_tests</span>::{<span class="ident">merino_test_macro</span>, <span class="ident">TestingTools</span>};

<span class="attribute">#[<span class="ident">merino_test_macro</span>(<span class="op">|</span><span class="ident">settings</span><span class="op">|</span> <span class="ident">settings</span>.<span class="ident">debug</span> <span class="op">=</span> <span class="bool-val">true</span>)]</span>
<span class="kw">async</span> <span class="kw">fn</span> <span class="ident">test_function</span>(<span class="ident">TestingTools</span> { <span class="ident">test_client</span>, .. }: <span class="ident">TestingTools</span>) {
    <span class="comment">// test using test_client while the debug setting is true.</span>
}</code></pre></div>
<p>Other test macros, like <code>parameterized</code>, can be used:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">merino_integration_tests</span>::{<span class="ident">TestingTools</span>, <span class="ident">merino_test_macro</span>};
<span class="kw">use</span> <span class="ident">parameterized::parameterized</span>;

<span class="attribute">#[<span class="ident">merino_test_macro</span>(<span class="op">|</span><span class="ident">settings</span>, <span class="ident">ttl</span>: <span class="ident">u64</span><span class="op">|</span> <span class="ident">settings</span>.<span class="ident">redis_cache</span>.<span class="ident">default_ttl</span> <span class="op">=</span> <span class="ident">ttl</span>)]</span>
<span class="attribute">#[<span class="ident">parameterized</span>(<span class="ident">ttl</span> <span class="op">=</span> { <span class="number">300</span>, <span class="number">600</span> })]</span>
<span class="kw">async</span> <span class="kw">fn</span> <span class="ident">test</span>(<span class="ident">TestingTools</span> { .. }: <span class="ident">TestingTools</span>) {
    <span class="comment">// test will run twice, once with each TTL setting.</span>
}</code></pre></div>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="utils/index.html" title="merino_integration_tests::utils mod">utils</a></div><div class="item-right docblock-short"><p>Utilities to aid in testing.</p>
</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.LogWatcher.html" title="merino_integration_tests::LogWatcher struct">LogWatcher</a></div><div class="item-right docblock-short"><p>Helper to collect events emitted by Tracing and later make assertions about
the collected events.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.MetricsWatcher.html" title="merino_integration_tests::MetricsWatcher struct">MetricsWatcher</a></div><div class="item-right docblock-short"><p>Helper to collect metrics during tests, and make assertions about them.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.TestingTools.html" title="merino_integration_tests::TestingTools struct">TestingTools</a></div><div class="item-right docblock-short"><p>A set of tools for tests, including mock servers and logging helpers.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.TracingJsonEvent.html" title="merino_integration_tests::TracingJsonEvent struct">TracingJsonEvent</a></div><div class="item-right docblock-short"><p>A deserialization of <a href="../tracing_subscriber/fmt/format/json/struct.Json.html" title="tracing_subscriber::fmt::format::Json"><code>tracing_subscriber::fmt::format::Json</code></a>’s output format.</p>
</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.merino_test.html" title="merino_integration_tests::merino_test fn">merino_test</a></div><div class="item-right docblock-short"><p>Run a test with a fully configured Merino server.</p>
</div></div></div><h2 id="attributes" class="small-section-header"><a href="#attributes">Attribute Macros</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="attr" href="attr.merino_test_macro.html" title="merino_integration_tests::merino_test_macro attr">merino_test_macro</a></div><div class="item-right docblock-short"><p>Wrap a test case in setup and tear down boiler plate, including manipulating
settings if needed.</p>
</div></div></div></section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../" data-current-crate="merino_integration_tests" data-search-index-js="../search-index.js" data-search-js="../search.js"></div>
</body></html>